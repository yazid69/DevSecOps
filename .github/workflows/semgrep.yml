name: Semgrep Scan

on: 
  pull_request:
    branches:
      - '*'

permissions:
  contents: read
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep scan
        id: semgrep
        run: |
          echo "Starting Semgrep scan..."
          semgrep --config .semgrep.yml --json > semgrep-results.json
          cat semgrep-results.json

      - name: Check for XSS errors
        id: check_xss_errors
        run: |
          if grep -q "Possible XSS vulnerability detected" semgrep-results.json; then
            echo "::set-output name=xss_detected::true"
            exit 1
          else
            echo "::set-output name=xss_detected::false"
          fi
          SEMGREP_OUTPUT=$(cat semgrep-results.json)
          echo "::set-output name=semgrep_output::$SEMGREP_OUTPUT"

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v2
        with:
          name: semgrep-results
          path: semgrep-results.json

  comment:
    runs-on: ubuntu-latest
    needs: semgrep
    if: always()
    steps:
      - name: Download Semgrep results
        uses: actions/download-artifact@v2
        with:
          name: semgrep-results

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const semgrepResults = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
            const pr = context.payload.pull_request;

            let message = '';

            if (semgrepResults.results.length > 0) {
              message += '## :warning: XSS Vulnerability Detected\n';
              semgrepResults.results.forEach(result => {
                if (result.extra.message.includes("Possible XSS vulnerability detected")) {
                  message += `- File: ${result.path}\n  Line: ${result.start.line}\n  Message: ${result.extra.message}\n\n`;
                }
              });
            } else {
              message += 'âœ… Semgrep found no issues.\n\n';
            }

            if (pr) {
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }
