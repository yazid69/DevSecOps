name: Semgrep Scan

on:
  pull_request:
    branches:
      - '*'

permissions:
  contents: read
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    outputs:
      xss_detected: ${{ steps.check_xss_errors.outputs.xss_detected }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep scan
        id: semgrep
        run: semgrep --config=p/r2c-security-audit --json > semgrep-results.json

      - name: Check for XSS errors
        id: check_xss_errors
        run: |
          if grep -q "XSS" semgrep-results.json; then
            echo "::set-output name=xss_detected::true"
          else
            echo "::set-output name=xss_detected::false"
          fi

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v2
        with:
          name: semgrep-results
          path: semgrep-results.json

  comment:
    runs-on: ubuntu-latest
    needs: semgrep
    if: needs.semgrep.outputs.xss_detected == 'true'
    steps:
      - name: Download Semgrep results
        uses: actions/download-artifact@v2
        with:
          name: semgrep-results

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
            const pr = context.payload.pull_request;

            let message = '## :warning: XSS Vulnerability Detected\n';
            results.results.forEach(result => {
              if (result.extra.message.includes("XSS")) {
                message += `- File: ${result.path}\n  Line: ${result.start.line}\n  Message: ${result.extra.message}\n\n`;
              }
            });

            if (pr) {
              await github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }
